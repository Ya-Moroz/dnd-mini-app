<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>D&D Session Tool</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg-paper: #f4ece1;
        --text-main: #4a3427;
        --border: #d6cbb3;
        --hp-red: #8b2c2c;
        --ac-blue: #2c5a8b;
        --speed-green: #2c8b5a;
        --gold: #8b5a2b;
      }

      body {
        background: #1a1a1a;
        color: var(--text-main);
        font-family: -apple-system, sans-serif;
        margin: 0;
        padding: 15px;
        padding-bottom: 120px;
      }

      #selector {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .char-btn {
        background: var(--bg-paper);
        padding: 25px 10px;
        border-radius: 12px;
        text-align: center;
        border: 2px solid var(--border);
        font-weight: bold;
      }

      #sheet {
        background: var(--bg-paper);
        border-radius: 15px;
        padding: 20px;
        display: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
      .back-link {
        color: var(--ac-blue);
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 15px;
        display: block;
      }
      .header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      #det-name {
        margin: 0;
        font-size: 24px;
        color: #5a2e17;
        border-bottom: 1px dashed var(--gold);
        outline: none;
      }

      .top-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }
      .top-box {
        background: rgba(0, 0, 0, 0.05);
        padding: 10px;
        border-radius: 6px;
        position: relative;
      }
      .top-box::before {
        content: "";
        position: absolute;
        left: 0;
        top: 15%;
        height: 70%;
        width: 4px;
      }
      .box-hp::before {
        background: var(--hp-red);
      }
      .box-ac::before {
        background: var(--ac-blue);
      }
      .box-speed::before {
        background: var(--speed-green);
      }
      .top-label {
        font-size: 9px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .top-val {
        font-size: 22px;
        font-weight: 900;
      }
      .hp-slider {
        width: 100%;
        margin-top: 10px;
        accent-color: var(--hp-red);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: #e8e0d0;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        border: 1px solid var(--border);
        cursor: pointer;
      }
      .stat-card:active {
        transform: scale(0.95);
        background: var(--border);
      }
      .stat-label {
        font-size: 10px;
        color: var(--gold);
        font-weight: bold;
      }

      .section-title {
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        margin: 15px 0 5px;
        color: var(--gold);
        border-top: 1px solid var(--border);
        padding-top: 10px;
      }
      .section-content {
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-line;
      }

      /* –ñ—É—Ä–Ω–∞–ª –±—Ä–æ—Å–∫–æ–≤ */
      .log-container {
        margin-top: 20px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 8px;
        padding: 10px;
        border: 1px solid var(--border);
      }
      .log-entry {
        font-size: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 4px 0;
        display: flex;
        justify-content: space-between;
      }
      .log-entry:last-child {
        border: none;
      }
      .log-res {
        font-weight: bold;
        color: var(--hp-red);
      }

      /* –ü–∞–Ω–µ–ª—å —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–∏–≤–∞–µ—Ç—Å—è —Å —Ñ–æ–Ω–æ–º #1a1a1a */
      .dice-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: transparent;
        display: flex;
        justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫—É–±–∏–∫–∏ */
        gap: 15px; /* –†–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –Ω–∏–º–∏ */
        padding: 20px 0;
        z-index: 100;
        pointer-events: none;
      }

      .dice-icon {
        pointer-events: auto;
        /* –¶–≤–µ—Ç–∞: –±–µ–ª—ã–π –∫—É–±–∏–∫, —Ç–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
        color: #333333;
        background: #ffffff;
        border: 2px solid #333333; /* –û–±–≤–æ–¥–∫–∞ –≤ —Ü–≤–µ—Ç —à—Ä–∏—Ñ—Ç–∞ */

        /* –§–æ—Ä–º–∞: —Å—Ç—Ä–æ–≥–∏–π –∫–≤–∞–¥—Ä–∞—Ç */
        aspect-ratio: 1 / 1; /* –î–µ–ª–∞–µ—Ç –≤—ã—Å–æ—Ç—É —Ä–∞–≤–Ω–æ–π —à–∏—Ä–∏–Ω–µ */
        width: 40px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        border-radius: 4px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞ */

        /* –®—Ä–∏—Ñ—Ç –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        font-weight: 900;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;

        cursor: pointer;
        /* –¢–µ–Ω—å –¥–ª—è –æ–±—ä–µ–º–∞ –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ */
        box-shadow: 0 4px 0px rgba(0, 0, 0, 0.2);
        transition: all 0.1s ease;
      }

      /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è (—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –≤–¥–∞–≤–ª–∏–≤–∞–Ω–∏–µ) */
      .dice-icon:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0px rgba(0, 0, 0, 0.2);
        background: #f0f0f0; /* –õ–µ–≥–∫–æ–µ –ø–æ—Ç–µ–º–Ω–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
      }
    </style>
  </head>
  <body>
    <div id="selector">
      <h2 style="text-align: center; color: white">
        –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å
      </h2>
    </div>

    <div id="sheet">
      <div class="back-link" onclick="location.reload()">‚Üê –ù–∞–∑–∞–¥</div>
      <div class="header">
        <h1 id="det-name" contenteditable="true">–ò–º—è</h1>
        <div style="text-align: right">
          <div style="font-size: 9px; color: var(--gold); font-weight: bold">
            –ö–õ–ê–°–°
          </div>
          <div id="det-class" style="font-weight: bold; font-size: 14px">
            ---
          </div>
        </div>
      </div>

      <div class="top-stats">
        <div class="top-box box-hp">
          <div class="top-label">–ó–¥–æ—Ä–æ–≤—å–µ</div>
          <div class="top-val" id="det-hp">0</div>
          <input type="range" id="hp-range" class="hp-slider" />
        </div>
        <div class="top-box box-ac">
          <div class="top-label">–ó–∞—â–∏—Ç–∞</div>
          <div class="top-val" id="det-ac">0</div>
        </div>
        <div class="top-box box-speed">
          <div class="top-label">–°–∫–æ—Ä–æ—Å—Ç—å</div>
          <div class="top-val" id="det-speed">0</div>
        </div>
      </div>

      <div class="stats-grid" id="stats-container"></div>

      <div class="section-title">‚öîÔ∏è –ê—Ç–∞–∫–∏</div>
      <div id="det-attacks" class="section-content"></div>

      <div class="section-title">‚ú® –£–º–µ–Ω–∏—è</div>
      <div id="det-skills" class="section-content"></div>

      <div class="section-title">üìú –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤</div>
      <div id="dice-log" class="log-container">
        <div style="color: #999; font-style: italic; font-size: 11px">
          –ë—Ä–æ—Å–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ...
        </div>
      </div>
    </div>

    <div class="dice-bar" id="dice-bar" style="display: none">
      <div class="dice-icon" onclick="rollPure(4)">D4</div>
      <div class="dice-icon" onclick="rollPure(6)">D6</div>
      <div class="dice-icon" onclick="rollPure(8)">D8</div>
      <div class="dice-icon" onclick="rollPure(10)">D10</div>
      <div class="dice-icon" onclick="rollPure(12)">D12</div>
      <div class="dice-icon" onclick="rollPure(20)">D20</div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();
      // –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã–º —Å–≤–∞–π–ø–æ–º –≤–Ω–∏–∑
tg.isClosingConfirmationEnabled = true; 

// –ö—Ä–∞—Å–∏—Ç –≤–µ—Ä—Ö–Ω—é—é –ø–æ–ª–æ—Å–∫—É (–≥–¥–µ —á–∞—Å—ã) –≤ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–≤–æ–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
tg.setHeaderColor('#1a1a1a');

      const charFiles = [
        "tordin.json",
        "ellana.json",
        "zephyr.json",
        "bruno.json",
        "finn.json",
        "balar.json",
        "gromm.json",
        "milo.json",
      ];
      const selector = document.getElementById("selector");
      const sheet = document.getElementById("sheet");
      const diceBar = document.getElementById("dice-bar");
      const logBox = document.getElementById("dice-log");

      async function init() {
        for (const file of charFiles) {
          try {
            const response = await fetch(`./${file}`);
            const data = await response.json();
            const btn = document.createElement("div");
            btn.className = "char-btn";
            btn.innerHTML = data.class;
            btn.onclick = () => renderCharacter(data);
            selector.appendChild(btn);
          } catch (e) {
            console.error(e);
          }
        }
      }

      function addToLog(text, result) {
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –±—Ä–æ—Å–æ–∫, –æ—á–∏—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        if (logBox.innerText.includes("–ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ")) logBox.innerHTML = "";

        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.innerHTML = `<span>${text}</span><span class="log-res">${result}</span>`;

        logBox.prepend(entry); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–µ—Ä—Ö

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 7 –∑–∞–ø–∏—Å–µ–π
        if (logBox.children.length > 7) {
          logBox.removeChild(logBox.lastChild);
        }
      }

      function rollPure(sides) {
        const res = Math.floor(Math.random() * sides) + 1;
        tg.HapticFeedback.impactOccurred("medium");
        addToLog(`–ö—É–±–∏–∫ d${sides}`, res);
      }

      function rollStat(name, mod) {
        const d20 = Math.floor(Math.random() * 20) + 1;
        const total = d20 + mod;
        const modStr = mod >= 0 ? `+${mod}` : mod;

        tg.HapticFeedback.notificationOccurred(
          d20 === 20 ? "success" : d20 === 1 ? "error" : "warning"
        );
        addToLog(`${name} (d20(${d20})${modStr})`, total);
      }

      function renderCharacter(c) {
        selector.style.display = "none";
        sheet.style.display = "block";
        diceBar.style.display = "flex";
        logBox.innerHTML =
          '<div style="color: #999; font-style: italic; font-size: 11px;">–ë—Ä–æ—Å–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ...</div>';

        document.getElementById("det-name").innerText = c.name;
        document.getElementById("det-class").innerText = c.class;
        document.getElementById("det-hp").innerText = c.hp;
        document.getElementById("det-ac").innerText = c.ac;
        document.getElementById("det-speed").innerText = c.speed;
        document.getElementById("det-attacks").innerText = c.attacks;
        document.getElementById("det-skills").innerText = c.skills;

        const slider = document.getElementById("hp-range");
        const hpDisplay = document.getElementById("det-hp");
        slider.max = c.hp;
        slider.value = c.hp;
        slider.oninput = () => {
          hpDisplay.innerText = slider.value;
        };

        const statsContainer = document.getElementById("stats-container");
        statsContainer.innerHTML = "";
        for (let [label, value] of Object.entries(c.stats)) {
          const mod = Math.floor((value - 10) / 2);
          const card = document.createElement("div");
          card.className = "stat-card";
          card.innerHTML = `<div class="stat-label">${label}</div><div class="stat-val">${value}</div><div style="font-size:11px; opacity:0.6">${
            mod >= 0 ? "+" + mod : mod
          }</div>`;
          card.onclick = () => rollStat(label, mod);
          statsContainer.appendChild(card);
        }
        tg.HapticFeedback.impactOccurred("light");
      }

      init();
    </script>
  </body>
</html>
